= SDIS Remocra - Manuel d'installation

ifdef::env-github,env-browser[:outfilesuffix: .adoc]

:experimental:
:icons: font

:toc:

:numbered:

link:../index{outfilesuffix}[Retour à l'accueil]

'''

Pour installer rapidement un serveur remocra, on réalise l'équivalent de ce qui est réalisé par Vagrant.

== Configuration initiale ==

Partir d'un serveur CentOS 6X vierge

Surcharger les variables d'environnement de _launcher.sh_ (mots de passe, mail, clé IGN, etc.) dans le terminal ou dans le profil de l'utilisateur _root_. Exemple :

./root/.bashrc (en fin de fichier) :
[source,bash]
----
### SDIS
export SRC_SDIS=XX

### URL du site
export URL_SITE="http://remocra/sdis${SRC_SDIS}.fr/remocra/"

### Base de données
export POSTGRES_DB_PASSWORD=1l4se52d56
export REMOCRA_DB_PASSWORD=1wdf5f1g

### Tomcat
export TOMCAT_ADMIN_USERNAME=remocraadm
export TOMCAT_ADMIN_PASSWORD=dg9o4zd54sd
export GEOSERVER_ADMIN_PASSWORD=nkje8d165d

### Utilisateurs
export APP_PASSWORD=5fs5ddsq1

### Courriels (par PDI)
export TECH_EMAIL=courriel@sdis{SRC_SDIS}.fr

### Divers
export APP_IGNKEYS="os15sdcg5dgcd541sd5c1sd4"
----

[red yellow-background]#⚠ Sourcer immédiatement le fichier : `. /root/.bashrc`#

Créer le répertoire d'accueil des éléments d'installation : `mkdir /livraison`

Déposer les scripts du répertoire _vagrant_ext/livraison_ :

* _/livraison/install_base.sh_
* _/livraison/install_remocra.sh_
* _/livraison/launcher.sh_

Rendre les scripts exécutables : `chmod u+x /livraison/*.sh`

== Lancement de l'installation ==

* Déposer l'archive remocra dans _/livraison_. Exemple :
** _/livraison/20171108_remocrapackage0.9.14-install.zip_

* Lancer l'installation : `/livraison/launcher.sh 2>&1 | tee /livraison/launcher.log`

Accès après l'installation :

* http://remocra.sdisXX.fr/remocra
* http://remocra.sdisXX.fr/geoserver


== Erreurs fréquemment obtenues ==

Si une erreur se produit, l'installation est immédiatement arrêtée. Le cas échéant, rechercher la cause de l'erreur, corriger manuellement les erreurs de manière à être dans un état cohérent et relancer l'installation.

Les *causes d'erreurs les plus courantes* sont les suivantes :

=== Tomcat n'a pas eu le temps de démarrer ===

* Détection : message obtenu dans le console lors de l'installation :
[source,ruby]
----
Stopping tomcat6: waiting for processes 43660 to exit
Starting tomcat6: ÉCHOUÉ
ABORTED - L'installation / mise à jour a été interrompue -
----

* Action : Redémarrer tomcat puis l'installation :
[source,ruby]
----
service tomcat6 restart && service tomcat6 status
/livraison/launcher.sh 2>&1 | tee /livraison/launcher.log
----

=== SELinux activé ===

* Détection : serveur inaccessible à la fin de l'installation malgré un message positif
* Action : désactiver SELinux

Désactiver SE Linux en modifiant le fichier :

./etc/selinux/config
[source,ruby]
----
SELINUX=disabled
----

Puis redémarrer le serveur avec la commande `reboot`

Exemple de vérification avec la commande `sestatus && getenforce` :
[source,ruby]
----
SELinux status:                 disabled
Disabled
----


=== Hostname mal paramétré ===

* Détection : Message du type `Erreur: Exception envoyée par l'agent : java.net.MalformedURLException: Local host name unknown: java.net.UnknownHostException: XXXXX: XXXXX: Nom ou service inconnu` dans le fichier `/var/log/tomcat6/catalina.out`
* Action : paramétrer le `hostname`

Exemples de fichiers :

./etc/hosts
[source,ruby]
----
127.0.0.1   localhost localhost.localdomain remocra.sdisXX.fr
::1         localhost localhost.localdomain remocra.sdisXX.fr
----

./etc/sysconfig/network
[source,ruby]
----
NETWORKING=yes
HOSTNAME=remocra.sdisXX.fr
----

Puis redémarrer le serveur avec la commande `reboot`

Exemple de vérification avec la commande `hostname` :
[source,ruby]
----
remocra.sdisXX.fr
----
